<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta http-equiv="Content-Security-Policy" content="{{csp}}">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="module" nonce="{{nonce}}" src="{{vscodeElementsUri}}"></script>
<style>
  body {
    font-family: var(--vscode-font-family);
    font-size: var(--vscode-font-size);
    color: var(--vscode-foreground);
    background-color: transparent;
    margin: 0;
    padding: 0.75rem;
    box-sizing: border-box;
  }
  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    align-items: flex-start;
  }
  .toolbar input {
    flex: 1 1 150px;
    min-width: 0;
    padding: 0.3rem 0.4rem;
    background: var(--vscode-input-background);
    color: var(--vscode-input-foreground);
    border: 1px solid var(--vscode-input-border, transparent);
    border-radius: 4px;
  }
  .toolbar vscode-multi-select {
    flex: 0 1 auto;
    min-width: 140px;
  }
  .toolbar button {
    flex: 0 0 auto;
    padding: 0 0.8rem;
    background: var(--vscode-button-secondaryBackground);
    border: 1px solid var(--vscode-button-border, transparent);
    color: var(--vscode-button-secondaryForeground);
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
  }
  .toolbar button:hover {
    background: var(--vscode-button-secondaryHoverBackground);
  }
  .issues {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .issue {
    padding: 0.6rem;
    border: 1px solid var(--vscode-editorWidget-border);
    border-radius: 4px;
    background: var(--vscode-editorWidget-background);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .issue:focus,
  .issue:hover {
    outline: none;
    background: var(--vscode-list-hoverBackground);
    border-color: var(--vscode-focusBorder);
  }
  .issue-title {
    font-weight: 600;
    margin-bottom: 0.2rem;
  }
  .issue-meta {
    font-size: 0.85rem;
    color: var(--vscode-descriptionForeground);
    margin-bottom: 0.3rem;
  }
  .empty,
  .error,
  .loading {
    text-align: center;
    padding: 1rem;
    color: var(--vscode-descriptionForeground);
  }
  .hidden {
    display: none;
  }
</style>
</head>
<body>
  <div class="toolbar">
    <input id="beads-search" type="search" placeholder="Search by title, id, or text" />
    <vscode-multi-select id="beads-status">
      <vscode-option value="open" selected>Open</vscode-option>
      <vscode-option value="in_progress" selected>In Progress</vscode-option>
      <vscode-option value="blocked" selected>Blocked</vscode-option>
      <vscode-option value="closed" selected>Closed</vscode-option>
    </vscode-multi-select>
    <vscode-multi-select id="beads-type">
      <vscode-option value="bug" selected>Bug</vscode-option>
      <vscode-option value="feature" selected>Feature</vscode-option>
      <vscode-option value="task" selected>Task</vscode-option>
      <vscode-option value="epic" selected>Epic</vscode-option>
      <vscode-option value="chore" selected>Chore</vscode-option>
    </vscode-multi-select>
    <button id="beads-refresh" type="button">Refresh</button>
  </div>
  <div id="beads-loading" class="loading hidden">Loading issues…</div>
  <div id="beads-error" class="error hidden"></div>
  <div id="beads-empty" class="empty hidden">No issues to display.</div>
  <ul id="beads-list" class="issues" aria-live="polite"></ul>
  <script nonce="{{nonce}}">
    (function() {
      const vscode = acquireVsCodeApi();
      const searchInput = document.getElementById('beads-search');
      const statusSelect = document.getElementById('beads-status');
      const typeSelect = document.getElementById('beads-type');
      const refreshButton = document.getElementById('beads-refresh');
      const listEl = document.getElementById('beads-list');
      const emptyEl = document.getElementById('beads-empty');
      const errorEl = document.getElementById('beads-error');
      const loadingEl = document.getElementById('beads-loading');
      let issues = [];

      function escapeHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }

      function toLower(value) {
        return typeof value === 'string' ? value.toLowerCase() : '';
      }

      function getDescription(issue) {
        const source = issue.description || issue.text || issue.notes || '';
        const text = String(source);
        if (text.length > 140) {
          return text.slice(0, 137) + '…';
        }
        return text;
      }

      function renderList() {
        const query = toLower(searchInput.value.trim());
        const statusFilters = statusSelect.value || [];
        const typeFilters = typeSelect.value || [];

        const filtered = issues.filter((issue) => {
          const combined = [issue.id, issue.title, issue.description, issue.text, issue.notes]
            .map(toLower)
            .some((value) => value.includes(query));
          const matchesStatus = statusFilters.length === 0 || statusFilters.includes(toLower(issue.status));
          const matchesType = typeFilters.length === 0 || typeFilters.includes(toLower(issue.type));
          return (!query || combined) && matchesStatus && matchesType;
        });

        listEl.innerHTML = '';
        if (!filtered.length) {
          emptyEl.classList.remove('hidden');
          return;
        }
        emptyEl.classList.add('hidden');

        filtered.forEach((issue) => {
          const li = document.createElement('li');
          li.className = 'issue';
          li.tabIndex = 0;
          const status = toLower(issue.status) || 'unknown';
          const priority = issue.priority !== undefined ? `P${issue.priority}` : '';
          const type = issue.type ? String(issue.type) : '';
          const assignee = issue.assignee ? `@${issue.assignee}` : '';
          const meta = [status, priority, type, assignee].filter(Boolean).join(' • ');
          li.innerHTML = `
            <div class="issue-title">${escapeHtml(issue.id || 'unknown')} · ${escapeHtml(issue.title || 'Untitled')}</div>
            <div class="issue-meta">${escapeHtml(meta)}</div>
          `;
          li.addEventListener('click', () => openIssue(issue.id));
          li.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
              openIssue(issue.id);
            }
          });
          listEl.appendChild(li);
        });
      }

      function openIssue(id) {
        if (!id) {
          return;
        }
        vscode.postMessage({ type: 'openIssue', id });
      }

      function setError(message) {
        if (message) {
          errorEl.textContent = message;
          errorEl.classList.remove('hidden');
        } else {
          errorEl.textContent = '';
          errorEl.classList.add('hidden');
        }
      }

      function setLoading(isLoading) {
        if (isLoading) {
          loadingEl.classList.remove('hidden');
        } else {
          loadingEl.classList.add('hidden');
        }
      }

      window.addEventListener('message', (event) => {
        switch (event.data?.type) {
          case 'issues':
            issues = Array.isArray(event.data.payload) ? event.data.payload : [];
            setError('');
            renderList();
            break;
          case 'error':
            setError(event.data.payload || 'Unable to load issues');
            break;
          case 'loading':
            setLoading(Boolean(event.data.payload));
            break;
          default:
            break;
        }
      });

      // Wait for custom elements to be defined before attaching listeners
      customElements.whenDefined('vscode-multi-select').then(() => {
        statusSelect.addEventListener('change', () => {
          console.log('Status changed:', statusSelect.value);
          renderList();
        });
        typeSelect.addEventListener('change', () => {
          console.log('Type changed:', typeSelect.value);
          renderList();
        });
      });

      refreshButton.addEventListener('click', () => {
        console.log('Refresh clicked');
        vscode.postMessage({ type: 'refresh' });
      });
      searchInput.addEventListener('input', renderList);

      vscode.postMessage({ type: 'ready' });
    })();
  </script>
</body>
</html>
